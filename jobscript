#!/bin/bash --login
#$ -cwd
#$ -l nvidia_v100    # 使用V100 GPU

# 定义要测试的数据集列表
dataset_list=("wikipedia" "mooc" "uci" "socialevolve_2weeks")

# 显示使用说明的函数
usage() {
    printf "Usage: %s <dataset>\n" "$0" >&2
    printf "Dataset options: wikipedia, mooc, uci, socialevolve_2weeks\n" >&2
    exit 1
}

# 检查是否提供了正确数量的参数
if [ $# -lt 1 ]; then
    usage
fi

# 验证输入的数据集
dataset=$1

# 验证数据集名称
valid_dataset=0
for d in "${dataset_list[@]}"; do
    if [ "$dataset" == "$d" ]; then
        valid_dataset=1
        break
    fi
done

if [ $valid_dataset -eq 0 ]; then
    printf "Error: Invalid dataset name. Use one of: wikipedia, mooc, uci, socialevolve_2weeks\n" >&2
    exit 1
fi

run_training() {
    local data=$1
    echo "Starting training on dataset: $data"
    python train_link_prediction.py --model_name FreeDyG --dataset_name "$data"

    # 检查训练是否成功
    if [ $? -eq 0 ]; then
        echo "Training completed successfully"
        return 0
    else
        echo "Training failed"
        return 1
    fi
}

run_evaluation() {
    local data=$1
    echo "Starting evaluation on dataset: $data"
    python evaluate_link_prediction.py --model_name FreeDyG --dataset_name "$data"

    # 检查评估是否成功
    if [ $? -eq 0 ]; then
        echo "Evaluation completed successfully"
        return 0
    else
        echo "Evaluation failed"
        return 1
    fi
}

# 激活conda环境
conda activate twgsl

# 将文件复制到GPU节点的本地存储
cp -r ~/papers/FreeDyG/ $TMPDIR

# 切换到工作目录
cd $TMPDIR/FreeDyG/

# 运行训练
run_training $dataset
training_status=$?

# 如果训练成功，则运行评估
if [ $training_status -eq 0 ]; then
    run_evaluation $dataset
    evaluation_status=$?
else
    echo "Skipping evaluation due to training failure"
    evaluation_status=1
fi

# 将结果复制回原始目录
rsync -av --progress \
    --exclude 'jobscript.e*' \
    --exclude 'jobscript.o*' \
    "$TMPDIR/FreeDyG/" ~/papers/FreeDyG/

# 休眠几秒确保文件同步
sleep 3

# 输出最终状态
if [ $training_status -eq 0 ] && [ $evaluation_status -eq 0 ]; then
    echo "Both training and evaluation completed successfully"
else
    echo "Process completed with errors"
    exit 1
fi

#$ -m ea
#$ -M jiafeng.xiong@manchester.ac.uk